var O=Object.defineProperty;var Y=(m,e,t)=>e in m?O(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var d=(m,e,t)=>Y(m,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();const y={laneCount:3,reserveTime:3,cameraEnabled:!1,mode:"normal"};function E(m,e){y[m]=e}class G{constructor(e){d(this,"phase","IDLE");d(this,"timer",0);d(this,"elapsed",0);d(this,"duration",0);d(this,"onPhaseChange");this.onPhaseChange=e}start(){y.mode==="realtime"?this.setPhase("REALTIME"):this.setPhase("READY")}reset(){this.phase="IDLE",this.timer=0,this.elapsed=0,this.duration=0}update(e){this.phase==="IDLE"||this.phase==="REALTIME"||(this.timer-=e,this.elapsed+=e,this.timer<=0&&this.advance())}advance(){switch(this.phase){case"READY":this.setPhase("RESERVE");break;case"RESERVE":this.setPhase("EXECUTE");break;case"EXECUTE":this.setPhase("RESERVE");break}}setPhase(e){var t;switch(this.phase=e,this.elapsed=0,e){case"READY":this.duration=1;break;case"RESERVE":this.duration=y.reserveTime;break;case"EXECUTE":this.duration=.5;break;case"REALTIME":this.duration=0;break;default:this.duration=0}this.timer=this.duration,(t=this.onPhaseChange)==null||t.call(this,e)}get progress(){return this.duration===0?0:Math.min(1,this.elapsed/this.duration)}}class ${constructor(){d(this,"lane",1);d(this,"action","stand");d(this,"x",0);d(this,"y",0);d(this,"displayY",0);d(this,"width",36);d(this,"height",48);d(this,"trail",[]);d(this,"maxTrailLength",30)}getLaneX(e,t,i){return t+i*e+i/2}setLane(e){const t=y.laneCount-1;this.lane=Math.max(0,Math.min(t,e))}setAction(e){this.action=e}updatePosition(e,t,i,a){this.x=this.getLaneX(this.lane,e,t),this.y=i*.78,this.action==="jump"?this.displayY=this.y-30:this.action==="crouch"?this.displayY=this.y+10:this.action==="pushup"?this.displayY=this.y+20:this.displayY=this.y,this.trail.push({x:this.x,lane:this.lane,action:this.action,time:a}),this.trail.length>this.maxTrailLength&&this.trail.shift()}getRect(){return this.action==="jump"?{x:this.x-this.width/2,y:this.displayY-this.height/2,w:this.width,h:this.height*.6}:this.action==="crouch"?{x:this.x-this.width/2,y:this.y,w:this.width,h:this.height*.4}:this.action==="pushup"?{x:this.x-this.width*.75,y:this.y+10,w:this.width*1.5,h:this.height*.2}:{x:this.x-this.width/2,y:this.y-this.height/2,w:this.width,h:this.height}}getDisplaySize(){return this.action==="crouch"?{w:this.width*1.2,h:this.height*.5}:this.action==="pushup"?{w:this.width*1.5,h:this.height*.3}:{w:this.width,h:this.height}}reset(){this.lane=y.laneCount===3?1:0,this.action="stand",this.trail=[]}}class j{constructor(){d(this,"obstacles",[]);d(this,"lastSpawnY",-80);d(this,"baseInterval",.8);d(this,"minInterval",.3)}update(e,t,i,a,o){for(const r of this.obstacles)r.y+=t*e;this.lastSpawnY+=t*e;const s=-3e3;for(;this.lastSpawnY>s;){let r=Math.max(this.minInterval,this.baseInterval-o*.008);y.mode==="realtime"&&(r*=2);const n=t*r;this.lastSpawnY-=n,this.spawn(a,o,this.lastSpawnY)}this.obstacles=this.obstacles.filter(r=>r.y<2e3)}spawn(e,t,i){const a=y.laneCount;let o="normal";if(t>.5){const s=Math.random();t>1&&s<.15?o="crawl":s<.35?o="ground":s<.6&&(o="overhead")}if(o==="ground"||o==="overhead"||o==="crawl")if(o==="crawl"?!0:Math.random()<.7)for(let r=0;r<a;r++)this.obstacles.push({lane:r,y:i,width:e*.7,height:o==="ground"?30:o==="crawl"?25:35,passed:!1,type:o});else{const r=Math.random()<.4?Math.min(2,a-1):1,n=Array.from({length:a},(l,h)=>h);for(let l=0;l<r;l++){const h=Math.floor(Math.random()*n.length);this.obstacles.push({lane:n[h],y:i,width:e*.7,height:o==="ground"?30:35,passed:!1,type:o}),n.splice(h,1)}}else{const s=a-1,r=Math.random()<.35?Math.min(2,s):1,n=[],l=Array.from({length:a},(h,c)=>c);for(let h=0;h<r;h++){const c=Math.floor(Math.random()*l.length);n.push(l[c]),l.splice(c,1)}for(const h of n)this.obstacles.push({lane:h,y:i,width:e*.6,height:50,passed:!1,type:"normal"})}}checkCollision(e,t,i,a){for(const o of this.obstacles){const s=i+a*o.lane+(a-o.width)/2;let r=o.y;if(o.type==="overhead"&&(r=o.y-20),!(o.type==="ground"&&t==="jump")&&!(o.type==="overhead"&&t==="crouch")&&!(o.type==="crawl"&&t==="pushup")&&e.x<s+o.width&&e.x+e.w>s&&e.y<r+o.height&&e.y+e.h>r)return!0}return!1}reset(){this.obstacles=[],this.lastSpawnY=-80}}class X{constructor(){d(this,"entries",[]);d(this,"recordInterval",.1);d(this,"lastRecordTime",0)}clear(){this.entries=[],this.lastRecordTime=0}record(e,t,i){(e-this.lastRecordTime>=this.recordInterval||this.entries.length===0)&&(this.entries.push({time:e,lane:t,action:i}),this.lastRecordTime=e)}getLaneAtProgress(e){if(this.entries.length===0)return 1;if(this.entries.length===1)return this.entries[0].lane;const t=this.entries[this.entries.length-1].time;if(t===0)return this.entries[0].lane;const i=e*t;for(let a=0;a<this.entries.length-1;a++)if(i>=this.entries[a].time&&i<=this.entries[a+1].time)return this.entries[a+1].lane;return this.entries[this.entries.length-1].lane}getActionAtProgress(e){if(this.entries.length===0)return"stand";if(this.entries.length===1)return this.entries[0].action;const t=this.entries[this.entries.length-1].time;if(t===0)return this.entries[0].action;const i=e*t;for(let a=0;a<this.entries.length-1;a++)if(i>=this.entries[a].time&&i<=this.entries[a+1].time)return this.entries[a+1].action;return this.entries[this.entries.length-1].action}getTrajectory(){return[...this.entries]}}class F{constructor(e){d(this,"ctx");d(this,"canvas");d(this,"roadLeft",0);d(this,"roadRight",0);d(this,"roadWidth",0);d(this,"laneWidth",0);d(this,"scrollOffset",0);d(this,"ripples",[]);d(this,"rippleTimer",0);d(this,"characterImages",[]);d(this,"currentFrame",0);d(this,"frameTimer",0);d(this,"FRAME_DURATION",.1);this.canvas=e,this.ctx=e.getContext("2d"),this.calcLayout(),this.initRipples(),this.loadCharacterImages()}loadCharacterImages(){for(let e=1;e<=6;e++){const t=new Image;t.src=`images/character/chara${e}.png`,this.characterImages.push(t)}}initRipples(){const e=this.canvas.width,t=this.canvas.height;for(let i=0;i<8;i++)this.ripples.push({x:Math.random()*e,y:Math.random()*t,radius:Math.random()*30,maxRadius:30+Math.random()*40,opacity:.08+Math.random()*.12,speed:8+Math.random()*12})}calcLayout(){const e=this.canvas.width;this.roadWidth=Math.min(e*.7,400),this.roadLeft=(e-this.roadWidth)/2,this.roadRight=this.roadLeft+this.roadWidth,this.laneWidth=this.roadWidth/y.laneCount}render(e,t,i,a,o,s,r,n,l,h,c){const{ctx:f,canvas:p}=this,u=p.width,g=p.height,b=f.createLinearGradient(0,0,0,g);if(b.addColorStop(0,"#5a8a7a"),b.addColorStop(.15,"#4a7a6e"),b.addColorStop(.4,"#3a6a60"),b.addColorStop(.7,"#2d5a55"),b.addColorStop(1,"#1e4a48"),f.fillStyle=b,f.fillRect(0,0,u,g),this.drawLakeBackground(u,g,l),(i==="EXECUTE"||i==="REALTIME"||i==="TITLE")&&(this.scrollOffset=(this.scrollOffset+r*l)%600),i!=="TITLE"&&(this.drawRoad(g),this.drawObstacles(t)),i==="RESERVE"&&(this.drawTravelZone(e,r*2,c,g,1),this.drawGhostPlayer(e)),i!=="TITLE"){if(i==="EXECUTE"){const M=o-a,v=Math.max(0,(c-M)/c);this.drawTravelZone(e,h,c,g,v)}this.drawPlayer(e,l),this.drawPhaseHUD(i,a,o,g,u),this.drawScore(s,u),this.drawActionIndicator(e,u),this.drawSpeedIndicator(r,u,g),this.drawPreviewMap(e,t,u,g)}}drawPreviewMap(e,t,i,a){const{ctx:o,roadLeft:s,laneWidth:r}=this,n=y.laneCount,l=Math.min(80,(i-this.roadRight)*.7),h=a*.82,c=this.roadRight+(i-this.roadRight-l)/2,f=a*.08;if(l<30)return;o.save(),o.globalAlpha=.85;const p=o.createLinearGradient(c,f,c,f+h);p.addColorStop(0,"rgba(30, 50, 45, 0.9)"),p.addColorStop(1,"rgba(20, 35, 32, 0.9)"),o.fillStyle=p,o.beginPath(),o.roundRect(c-2,f-2,l+4,h+4,6),o.fill(),o.strokeStyle="rgba(100, 160, 140, 0.35)",o.lineWidth=1,o.stroke(),o.globalAlpha=1,o.fillStyle="rgba(196, 164, 106, 0.6)",o.font="600 9px 'Shippori Mincho', serif",o.textAlign="center",o.textBaseline="bottom",o.fillText("先読",c+l/2,f-5),o.save(),o.beginPath(),o.roundRect(c,f,l,h,4),o.clip();const u=o.createLinearGradient(c,f,c+l,f);u.addColorStop(0,"rgba(120, 80, 40, 0.5)"),u.addColorStop(.1,"rgba(160, 110, 60, 0.4)"),u.addColorStop(.9,"rgba(160, 110, 60, 0.4)"),u.addColorStop(1,"rgba(120, 80, 40, 0.5)"),o.fillStyle=u,o.fillRect(c,f,l,h);const g=l/n;o.strokeStyle="rgba(196, 164, 106, 0.2)",o.lineWidth=.5,o.setLineDash([3,3]);for(let S=1;S<n;S++){const T=c+g*S;o.beginPath(),o.moveTo(T,f),o.lineTo(T,f+h),o.stroke()}o.setLineDash([]);const b=3e3,M=e.y,v=M-b;for(const S of t.obstacles){if(S.y>M)continue;const T=(S.y-v)/(M-v);if(T<0||T>1)continue;const B=f+T*h,_=c+g*S.lane+(g-g*.7)/2,D=g*.7,W=Math.max(4,S.height*.15);let C;switch(S.type){case"ground":C="rgba(60, 200, 120, 0.7)";break;case"overhead":C="rgba(100, 180, 255, 0.7)";break;case"crawl":C="rgba(180, 100, 240, 0.7)";break;default:C="rgba(230, 200, 80, 0.7)"}o.fillStyle=C,o.fillRect(_,B,D,W)}const L=c+g*e.lane+g/2,x=f+h-6;o.fillStyle="rgba(183, 65, 50, 0.9)",o.beginPath(),o.moveTo(L,x-5),o.lineTo(L-4,x+3),o.lineTo(L+4,x+3),o.closePath(),o.fill(),o.restore(),o.restore()}drawLakeBackground(e,t,i){const{ctx:a}=this,o=performance.now()/1e3;a.save();for(let s=0;s<12;s++){const r=t/13*(s+.5),n=.08+Math.sin(o*.4+s*.8)*.04;a.strokeStyle=`rgba(100, 210, 195, ${Math.max(.02,n)})`,a.lineWidth=1.5+Math.sin(o*.2+s)*.5,a.beginPath();for(let l=0;l<=e;l+=3){const h=r+Math.sin(l*.012+o*.8+s*1)*12+Math.sin(l*.006+o*.5+s*.5)*8+Math.cos(l*.02+o*1.2+s*1.5)*4;l===0?a.moveTo(l,h):a.lineTo(l,h)}a.stroke()}a.restore(),a.save(),a.globalAlpha=.06;for(let s=0;s<8;s++){const r=e/2+Math.sin(o*.3+s*1.5)*e*.4,n=t/2+Math.cos(o*.25+s*1.8)*t*.4,l=60+Math.sin(o*.5+s)*30,h=a.createRadialGradient(r,n,0,r,n,l);h.addColorStop(0,"rgba(150, 240, 220, 0.8)"),h.addColorStop(.5,"rgba(100, 200, 180, 0.3)"),h.addColorStop(1,"rgba(80, 180, 160, 0)"),a.fillStyle=h,a.beginPath(),a.arc(r,n,l,0,Math.PI*2),a.fill()}a.globalAlpha=1,a.restore(),this.rippleTimer+=i,this.rippleTimer>.35&&(this.rippleTimer=0,this.ripples.length<25&&this.ripples.push({x:Math.random()*e,y:Math.random()*t,radius:0,maxRadius:40+Math.random()*70,opacity:.1+Math.random()*.12,speed:15+Math.random()*25}));for(let s=this.ripples.length-1;s>=0;s--){const r=this.ripples[s];r.radius+=r.speed*i;const n=1-r.radius/r.maxRadius;if(n<=0){this.ripples[s]={x:Math.random()*e,y:Math.random()*t,radius:0,maxRadius:40+Math.random()*70,opacity:.1+Math.random()*.12,speed:15+Math.random()*25};continue}a.strokeStyle=`rgba(140, 230, 210, ${Math.max(0,r.opacity*n)})`,a.lineWidth=1.8,a.beginPath(),a.ellipse(r.x,r.y,Math.max(0,r.radius),Math.max(0,r.radius*.45),0,0,Math.PI*2),a.stroke(),r.radius>10&&(a.strokeStyle=`rgba(160, 240, 220, ${Math.max(0,r.opacity*n*.5)})`,a.lineWidth=1,a.beginPath(),a.ellipse(r.x,r.y,Math.max(0,r.radius*.55),Math.max(0,r.radius*.25),0,0,Math.PI*2),a.stroke())}a.save();for(let s=0;s<30;s++){const r=(Math.sin(o*.35+s*1.1)*.5+.5)*e,n=(Math.cos(o*.25+s*1.5)*.5+.5)*t,l=.05+Math.sin(o*1+s*.6)*.04;a.fillStyle=`rgba(200, 250, 240, ${Math.max(0,l)})`,a.beginPath();const h=Math.max(0,25+Math.sin(o*.6+s)*15),c=Math.max(0,5+Math.sin(o*.8+s)*2);a.ellipse(r,n,h,c,Math.sin(o*.15+s)*.5,0,Math.PI*2),a.fill()}for(let s=0;s<30;s++){const r=(Math.sin(o*.6+s*1.7)*.5+.5)*e,n=(Math.cos(o*.5+s*1.4)*.5+.5)*t,l=Math.max(0,Math.sin(o*2+s*.9)*.25);if(l>.03){a.strokeStyle=`rgba(255, 255, 255, ${l*.5})`,a.lineWidth=1;const h=4+l*12;a.beginPath(),a.moveTo(r-h,n),a.lineTo(r+h,n),a.stroke(),a.beginPath(),a.moveTo(r,n-h),a.lineTo(r,n+h),a.stroke(),a.fillStyle=`rgba(255, 255, 255, ${l})`,a.beginPath(),a.arc(r,n,2+l*3,0,Math.PI*2),a.fill()}}a.restore()}drawDistantTrees(e,t){const{ctx:i,roadLeft:a,roadRight:o}=this,s=60;i.save();const r=i.createLinearGradient(0,s-30,0,s+40);r.addColorStop(0,"rgba(80, 130, 70, 0.6)"),r.addColorStop(.5,"rgba(60, 110, 55, 0.5)"),r.addColorStop(1,"rgba(50, 90, 50, 0.0)"),i.fillStyle=r,i.beginPath(),i.moveTo(0,s+40);for(let l=0;l<=a-10;l+=12){const h=25+Math.sin(l*.05)*15+Math.cos(l*.08)*10;i.lineTo(l,s-h)}i.lineTo(a-10,s+40),i.closePath(),i.fill();const n=i.createLinearGradient(0,s-30,0,s+40);n.addColorStop(0,"rgba(80, 130, 70, 0.6)"),n.addColorStop(.5,"rgba(60, 110, 55, 0.5)"),n.addColorStop(1,"rgba(50, 90, 50, 0.0)"),i.fillStyle=n,i.beginPath(),i.moveTo(o+10,s+40);for(let l=o+10;l<=e;l+=12){const h=20+Math.sin(l*.06)*15+Math.cos(l*.04)*10;i.lineTo(l,s-h)}i.lineTo(e,s+40),i.closePath(),i.fill(),i.strokeStyle="rgba(100, 160, 90, 0.25)",i.lineWidth=1,i.beginPath(),i.moveTo(0,s+35),i.lineTo(a-15,s+35),i.stroke(),i.beginPath(),i.moveTo(o+15,s+35),i.lineTo(e,s+35),i.stroke(),i.restore()}drawRoad(e){const{ctx:t,roadLeft:i,roadWidth:a}=this,o=y.laneCount;t.fillStyle="rgba(20, 50, 45, 0.3)",t.fillRect(i-4,0,a+8,e);const s=t.createLinearGradient(i,0,i+a,0);s.addColorStop(0,"#6b3a20"),s.addColorStop(.08,"#7a4528"),s.addColorStop(.15,"#8b5030"),s.addColorStop(.5,"#9a5a35"),s.addColorStop(.85,"#8b5030"),s.addColorStop(.92,"#7a4528"),s.addColorStop(1,"#6b3a20"),t.fillStyle=s,t.fillRect(i,0,a,e);const r=40,n=this.scrollOffset%r;t.save();for(let c=-r+n;c<e+r;c+=r){const f=c-this.scrollOffset,u=(Math.floor(f/r)%3+3)%3;u===0?t.fillStyle="rgba(80, 40, 20, 0.08)":u===1?t.fillStyle="rgba(120, 60, 30, 0.08)":t.fillStyle="rgba(100, 50, 25, 0.0)",t.fillRect(i,c,a,r),t.strokeStyle="rgba(50, 25, 10, 0.3)",t.lineWidth=1,t.beginPath(),t.moveTo(i+2,c),t.lineTo(i+a-2,c),t.stroke()}t.restore(),t.strokeStyle="rgba(60, 30, 15, 0.08)",t.lineWidth=1;for(let c=i+8;c<i+a;c+=14)t.beginPath(),t.moveTo(c,0),t.lineTo(c,e),t.stroke();t.fillStyle="#5a2e18",t.fillRect(i-4,0,6,e),t.fillRect(i+a-2,0,6,e),t.strokeStyle="rgba(180, 130, 80, 0.3)",t.lineWidth=1,t.beginPath(),t.moveTo(i-1,0),t.lineTo(i-1,e),t.stroke(),t.beginPath(),t.moveTo(i+a+1,0),t.lineTo(i+a+1,e),t.stroke();const l=120,h=this.scrollOffset%l;t.fillStyle="#4a2515";for(let c=-l+h;c<e+l;c+=l)t.fillRect(i-6,c-3,10,6),t.fillRect(i+a-4,c-3,10,6);t.setLineDash([20,30]),t.lineDashOffset=-this.scrollOffset,t.strokeStyle="rgba(50, 25, 10, 0.15)",t.lineWidth=1;for(let c=1;c<o;c++){const f=i+this.laneWidth*c;t.beginPath(),t.moveTo(f,0),t.lineTo(f,e),t.stroke()}t.setLineDash([]),t.lineDashOffset=0,t.fillStyle="rgba(200, 160, 100, 0.04)";for(let c=-r+n;c<e+r;c+=r*2)t.fillRect(i+2,c,a-4,r*.6)}drawPlayer(e,t){const{ctx:i}=this,a=e.x,o=e.displayY,s=e.action;this.frameTimer+=t,this.frameTimer>=this.FRAME_DURATION&&(this.frameTimer=0,this.currentFrame=(this.currentFrame+1)%this.characterImages.length);const r=this.characterImages[this.currentFrame];if(!r||!r.complete){this.drawPlayerFallback(e);return}const n=e.width*2.5;i.save(),i.translate(a,o),i.save(),i.scale(1,.3),i.fillStyle="rgba(0, 0, 0, 0.3)",i.beginPath();const l=(e.y-o)/.3+20;i.arc(0,l,n*.2,0,Math.PI*2),i.fill(),i.restore(),s==="jump"?this.drawJumpEffect(i,n/2.5):s==="crouch"?(i.scale(1.1,.7),i.translate(0,n*.15),this.drawCrouchEffect(i,n/2.5)):s==="pushup"&&(i.scale(1.3,.4),i.translate(0,n*.3),this.drawPushupEffect(i,n/2.5)),i.drawImage(r,-n/2,-n/2,n,n),i.fillStyle="rgba(255, 255, 255, 0.9)",i.font="bold 16px 'Shippori Mincho', serif",i.textAlign="center",i.textBaseline="middle";let h="";s==="jump"?h="跳":s==="crouch"?h="屈":s==="pushup"&&(h="伏"),h&&i.fillText(h,0,-n/2-10),i.restore()}drawJumpEffect(e,t){e.save(),e.globalCompositeOperation="source-over",e.fillStyle="rgba(60, 200, 120, 0.2)",e.beginPath(),e.arc(0,0,t*1.2,0,Math.PI*2),e.fill(),e.restore()}drawCrouchEffect(e,t){e.save(),e.fillStyle="rgba(100, 180, 255, 0.2)",e.beginPath(),e.ellipse(0,0,t*1.2,t*.8,0,0,Math.PI*2),e.fill(),e.restore()}drawPushupEffect(e,t){e.save(),e.fillStyle="rgba(180, 100, 240, 0.2)",e.beginPath(),e.ellipse(0,0,t*1.4,t*.6,0,0,Math.PI*2),e.fill(),e.restore()}drawPlayerFallback(e){const{ctx:t}=this,i=e.x,a=e.displayY,o=e.action,s=e.width*.6;if(t.save(),o==="jump"){t.shadowColor="rgba(60, 200, 120, 0.5)",t.shadowBlur=28,t.fillStyle="rgba(0, 0, 0, 0.2)",t.beginPath(),t.ellipse(i,e.y+10,s*.7,s*.2,0,0,Math.PI*2),t.fill();const r=performance.now()/1e3;t.strokeStyle="rgba(60, 200, 120, 0.3)",t.lineWidth=1;for(let l=0;l<3;l++){const h=r*2+l*(Math.PI*2/3),c=i+Math.cos(h)*(s+8),f=a+Math.sin(h)*(s*.5+4);t.beginPath(),t.arc(c,f,3,0,Math.PI*2),t.stroke()}t.strokeStyle="rgba(60, 200, 120, 0.35)",t.lineWidth=1.5,t.beginPath(),t.arc(i,a,s+12,0,Math.PI*2),t.stroke();const n=t.createRadialGradient(i,a-3,2,i,a,s);n.addColorStop(0,"#8ee8a5"),n.addColorStop(.5,"#4ab575"),n.addColorStop(1,"#2a7040"),t.fillStyle=n,t.beginPath(),t.arc(i,a,s,0,Math.PI*2),t.fill(),t.fillStyle="rgba(220, 255, 230, 0.8)",t.font=`bold ${s*.75}px 'Shippori Mincho', serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("跳",i,a+1)}else if(o==="crouch"){t.shadowColor="rgba(100, 180, 255, 0.4)",t.shadowBlur=16,t.strokeStyle="rgba(100, 180, 255, 0.3)",t.lineWidth=1.5,t.beginPath(),t.ellipse(i,a+6,s+10,(s+10)*.45,0,0,Math.PI*2),t.stroke();const r=t.createRadialGradient(i,a+4,2,i,a+4,s);r.addColorStop(0,"#8ec5e8"),r.addColorStop(.5,"#4a8ab5"),r.addColorStop(1,"#2a5070"),t.fillStyle=r,t.beginPath(),t.ellipse(i,a+6,s,s*.45,0,0,Math.PI*2),t.fill(),t.fillStyle="rgba(220, 240, 255, 0.8)",t.font=`bold ${s*.55}px 'Shippori Mincho', serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("屈",i,a+7)}else if(o==="pushup"){t.shadowColor="rgba(180, 100, 240, 0.4)",t.shadowBlur=16,t.strokeStyle="rgba(180, 100, 240, 0.3)",t.lineWidth=1.5,t.beginPath(),t.ellipse(i,a+8,s+14,(s+14)*.28,0,0,Math.PI*2),t.stroke();const r=t.createRadialGradient(i,a+6,2,i,a+6,s);r.addColorStop(0,"#d4a8e8"),r.addColorStop(.5,"#a060c0"),r.addColorStop(1,"#6b2080"),t.fillStyle=r,t.beginPath(),t.ellipse(i,a+8,s*1.2,s*.3,0,0,Math.PI*2),t.fill(),t.fillStyle="rgba(240, 220, 255, 0.8)",t.font=`bold ${s*.45}px 'Shippori Mincho', serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("伏",i,a+9)}else{t.shadowColor="rgba(183, 65, 50, 0.4)",t.shadowBlur=24,t.strokeStyle="rgba(183, 65, 50, 0.3)",t.lineWidth=1.5,t.beginPath(),t.arc(i,a,s+12,0,Math.PI*2),t.stroke();const r=performance.now()/1e3;t.save(),t.translate(i,a),t.rotate(r*.5);for(let l=0;l<4;l++)t.rotate(Math.PI/2),t.strokeStyle="rgba(196, 164, 106, 0.2)",t.beginPath(),t.moveTo(s+4,0),t.lineTo(s+10,0),t.stroke();t.restore();const n=t.createRadialGradient(i,a-3,2,i,a,s);n.addColorStop(0,"#d4836a"),n.addColorStop(.5,"#b74132"),n.addColorStop(1,"#6b2a1f"),t.fillStyle=n,t.beginPath(),t.arc(i,a,s,0,Math.PI*2),t.fill(),t.fillStyle="rgba(196, 164, 106, 0.7)",t.font=`bold ${s*.8}px 'Shippori Mincho', serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("呪",i,a+1)}t.shadowBlur=0,t.restore()}drawObstacles(e){const{ctx:t,roadLeft:i,laneWidth:a}=this;for(const o of e.obstacles){const s=i+a*o.lane+(a-o.width)/2;let r=o.y;if(t.save(),o.type==="ground"){t.shadowColor="rgba(60, 140, 60, 0.4)",t.shadowBlur=8;const n=t.createLinearGradient(s,r,s,r+o.height);n.addColorStop(0,"#1a3020"),n.addColorStop(.5,"#2a4a30"),n.addColorStop(1,"#1a3020"),t.fillStyle=n,this.drawRoundRect(t,s,r+o.height*.3,o.width,o.height*.7,2),t.fill(),t.strokeStyle="rgba(100, 200, 100, 0.35)",t.lineWidth=1,t.stroke(),t.fillStyle="rgba(100, 200, 100, 0.4)";const l=5;for(let h=0;h<l;h++){const c=s+o.width/(l+1)*(h+1),f=r+o.height*.3;t.beginPath(),t.moveTo(c-3,f),t.lineTo(c,f-8),t.lineTo(c+3,f),t.closePath(),t.fill()}t.shadowBlur=0,t.fillStyle="rgba(140, 220, 140, 0.7)",t.font="bold 14px 'Shippori Mincho', serif",t.textAlign="center",t.textBaseline="middle",t.fillText("茨",s+o.width/2,r+o.height*.65)}else if(o.type==="overhead"){r=o.y-20,t.shadowColor="rgba(100, 180, 255, 0.4)",t.shadowBlur=10;const n=t.createLinearGradient(s,r,s,r+o.height);n.addColorStop(0,"#153050"),n.addColorStop(.5,"#204070"),n.addColorStop(1,"#153050"),t.fillStyle=n,this.drawRoundRect(t,s,r,o.width,o.height*.6,2),t.fill(),t.strokeStyle="rgba(100, 180, 255, 0.4)",t.lineWidth=1,t.stroke(),t.strokeStyle="rgba(100, 180, 255, 0.2)",t.setLineDash([4,4]);const l=4;for(let h=0;h<l;h++){const c=s+o.width/(l+1)*(h+1);t.beginPath(),t.moveTo(c,r+o.height*.6),t.lineTo(c,r+o.height+5),t.stroke()}t.setLineDash([]),t.shadowBlur=0,t.fillStyle="rgba(180, 220, 255, 0.7)",t.font="bold 14px 'Shippori Mincho', serif",t.textAlign="center",t.textBaseline="middle",t.fillText("天",s+o.width/2,r+o.height*.3)}else if(o.type==="crawl")this.drawCrawlObstacle(t,s,r,o);else{t.shadowColor="rgba(230, 200, 80, 0.4)",t.shadowBlur=10;const n=t.createLinearGradient(s,r,s,r+o.height);n.addColorStop(0,"#403515"),n.addColorStop(.5,"#5c4e1f"),n.addColorStop(1,"#403515"),t.fillStyle=n,this.drawRoundRect(t,s,r,o.width,o.height,3),t.fill(),t.strokeStyle="rgba(230, 200, 80, 0.4)",t.lineWidth=1.5,t.stroke(),t.shadowBlur=0,t.fillStyle="rgba(255, 230, 150, 0.7)",t.font="bold 18px 'Shippori Mincho', serif",t.textAlign="center",t.textBaseline="middle",t.fillText("壁",s+o.width/2,r+o.height/2)}t.restore()}}drawCrawlObstacle(e,t,i,a){e.shadowColor="rgba(180, 100, 240, 0.4)",e.shadowBlur=8;const o=e.createLinearGradient(t,i,t,i+a.height);o.addColorStop(0,"#402060"),o.addColorStop(.5,"#603080"),o.addColorStop(1,"#402060"),e.fillStyle=o,this.drawRoundRect(e,t,i+a.height*.4,a.width,a.height*.6,2),e.fill(),e.strokeStyle="rgba(200, 120, 255, 0.4)",e.lineWidth=1,e.stroke(),e.strokeStyle="rgba(200, 120, 255, 0.3)",e.lineWidth=1,e.beginPath();for(let s=t+4;s<t+a.width-4;s+=6){const r=i+a.height*.5+Math.sin(s*.3)*3;s===t+4?e.moveTo(s,r):e.lineTo(s,r)}e.stroke(),e.shadowBlur=0,e.fillStyle="rgba(240, 200, 255, 0.7)",e.font="bold 14px 'Shippori Mincho', serif",e.textAlign="center",e.textBaseline="middle",e.fillText("窟",t+a.width/2,i+a.height*.7)}drawRoundRect(e,t,i,a,o,s){e.beginPath(),e.moveTo(t+s,i),e.lineTo(t+a-s,i),e.quadraticCurveTo(t+a,i,t+a,i+s),e.lineTo(t+a,i+o-s),e.quadraticCurveTo(t+a,i+o,t+a-s,i+o),e.lineTo(t+s,i+o),e.quadraticCurveTo(t,i+o,t,i+o-s),e.lineTo(t,i+s),e.quadraticCurveTo(t,i,t+s,i),e.closePath()}drawGhostPlayer(e){const{ctx:t,roadLeft:i,laneWidth:a}=this,o=y.laneCount,s=e.width*.6,r=e.y;t.save();for(let n=0;n<o;n++){const l=e.getLaneX(n,i,a),h=n===e.lane,c=h?.35:.1;t.fillStyle=`rgba(183, 65, 50, ${c})`,t.beginPath(),t.arc(l,r,s,0,Math.PI*2),t.fill(),t.strokeStyle=`rgba(183, 65, 50, ${c*.8})`,t.lineWidth=1,t.beginPath(),t.arc(l,r,s+8,0,Math.PI*2),t.stroke(),h&&(t.fillStyle=`rgba(196, 164, 106, ${c*1.5})`,t.font=`bold ${s*.7}px 'Shippori Mincho', serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("呪",l,r+1),e.action==="jump"?(t.fillStyle="rgba(60, 200, 120, 0.5)",t.font=`bold ${s*.5}px 'Shippori Mincho', serif`,t.fillText("跳",l,r-s-10)):e.action==="crouch"?(t.fillStyle="rgba(100, 180, 255, 0.5)",t.font=`bold ${s*.5}px 'Shippori Mincho', serif`,t.fillText("屈",l,r-s-10)):e.action==="pushup"&&(t.fillStyle="rgba(180, 100, 240, 0.5)",t.font=`bold ${s*.5}px 'Shippori Mincho', serif`,t.fillText("伏",l,r-s-10)))}t.restore()}drawTravelZone(e,t,i,a,o){const{ctx:s,roadLeft:r,roadWidth:n}=this,h=e.y-20,c=t*i*o,f=Math.min(c,h),p=e.y-f,u=o<1;s.save();const g=u?"60, 200, 120":"106, 159, 212",b=s.createLinearGradient(0,p,0,e.y);b.addColorStop(0,`rgba(${g}, 0.15)`),b.addColorStop(.3,`rgba(${g}, 0.06)`),b.addColorStop(1,`rgba(${g}, 0.0)`),s.fillStyle=b,s.fillRect(r+2,p,n-4,f),s.strokeStyle=`rgba(${g}, 0.7)`,s.lineWidth=2,s.setLineDash([8,6]),s.beginPath(),s.moveTo(r+5,p),s.lineTo(r+n-5,p),s.stroke(),s.setLineDash([]),s.fillStyle=`rgba(${g}, 0.7)`,s.beginPath(),s.arc(r+8,p,3,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(r+n-8,p,3,0,Math.PI*2),s.fill(),s.font="700 13px 'Shippori Mincho', serif",s.textAlign="center",s.textBaseline="bottom",s.fillStyle=`rgba(${g}, 0.8)`,s.fillText("到達線",r+n/2,p-6),s.restore()}drawAfterimage(e){const{ctx:t}=this,i=e.trail,a=i.length;for(let o=Math.max(0,a-15);o<a;o++){const s=i[o],r=(o-(a-15))/15*.25;s.action==="jump"?t.fillStyle=`rgba(60, 200, 120, ${r})`:s.action==="crouch"?t.fillStyle=`rgba(100, 180, 255, ${r})`:s.action==="pushup"?t.fillStyle=`rgba(180, 100, 240, ${r})`:t.fillStyle=`rgba(183, 65, 50, ${r})`,t.beginPath();const n=s.action==="crouch"?e.width*.4:e.width*.35;t.arc(s.x,e.y,n,0,Math.PI*2),t.fill()}}drawPhaseHUD(e,t,i,a,o){const{ctx:s}=this;if(e==="IDLE")return;const n={READY:{kanji:"構",color:"#c4a46a"},RESERVE:{kanji:"予約",color:"#6a9fd4"},EXECUTE:{kanji:"発動",color:"#3cc878"},AFTERIMAGE:{kanji:"残",color:"rgba(60, 200, 120, 0.5)"},REALTIME:{kanji:"実戦",color:"#ff4d4d"}}[e];if(!n)return;if(s.save(),s.textAlign="center",s.textBaseline="top",s.font="800 36px 'Shippori Mincho', serif",s.fillStyle=n.color,s.shadowColor=n.color,s.shadowBlur=20,s.fillText(n.kanji,o/2,16),e==="REALTIME"){s.restore();return}const l=Math.max(0,t).toFixed(1);s.font="700 16px 'Shippori Mincho', serif",s.fillStyle="rgba(232, 220, 200, 0.6)",s.shadowBlur=0,s.fillText(`${l}秒`,o/2,56);const h=160,c=3,f=o/2-h/2,p=78,u=i>0?Math.max(0,1-t/i):0;s.fillStyle="rgba(196, 164, 106, 0.1)",s.fillRect(f,p,h,c);const g=s.createLinearGradient(f,p,f+h*u,p);g.addColorStop(0,n.color),g.addColorStop(1,n.color),s.fillStyle=g,s.fillRect(f,p,h*u,c),s.fillStyle="rgba(196, 164, 106, 0.3)",s.fillRect(f-1,p-2,2,c+4),s.fillRect(f+h-1,p-2,2,c+4),s.restore()}drawScore(e,t){const{ctx:i}=this;i.save(),i.textAlign="right",i.textBaseline="top",i.font="600 11px 'Shippori Mincho', serif",i.fillStyle="rgba(196, 164, 106, 0.4)",i.fillText("距離",t-20,16),i.font="800 22px 'Shippori Mincho', serif",i.fillStyle="#c4a46a",i.shadowColor="rgba(196, 164, 106, 0.2)",i.shadowBlur=10,i.fillText(`${Math.floor(e)} m`,t-20,30),i.shadowBlur=0,i.restore()}drawActionIndicator(e,t){const{ctx:i}=this;e.action!=="stand"&&(i.save(),i.textAlign="left",i.textBaseline="top",e.action==="jump"?(i.font="700 18px 'Shippori Mincho', serif",i.fillStyle="rgba(60, 200, 120, 0.8)",i.shadowColor="rgba(60, 200, 120, 0.3)",i.shadowBlur=10,i.fillText("跳ぶ",20,20)):e.action==="crouch"?(i.font="700 18px 'Shippori Mincho', serif",i.fillStyle="rgba(100, 180, 255, 0.8)",i.shadowColor="rgba(100, 180, 255, 0.3)",i.shadowBlur=10,i.fillText("屈む",20,20)):e.action==="pushup"&&(i.font="700 18px 'Shippori Mincho', serif",i.fillStyle="rgba(180, 100, 240, 0.8)",i.shadowColor="rgba(180, 100, 240, 0.3)",i.shadowBlur=10,i.fillText("伏せる",20,20)),i.shadowBlur=0,i.restore())}drawSpeedIndicator(e,t,i){const{ctx:a}=this;a.save();const o=Math.min(e/800,1),s=Math.floor(o*8);for(let r=0;r<s;r++){const n=this.roadLeft-15-Math.random()*30,l=Math.random()*i,h=15+o*35,c=.04+o*.06;a.strokeStyle=`rgba(140, 200, 190, ${c})`,a.lineWidth=1,a.beginPath(),a.moveTo(n,l),a.lineTo(n+(Math.random()-.5)*3,l+h),a.stroke();const f=this.roadRight+15+Math.random()*30;a.beginPath(),a.moveTo(f,l),a.lineTo(f+(Math.random()-.5)*3,l+h),a.stroke()}a.restore()}}function H(m,e,t){const i=document.getElementById("settingsPanel"),a=document.getElementById("gameOverPanel"),o=document.getElementById("startBtn"),s=document.getElementById("restartBtn");document.querySelectorAll(".btn-option").forEach(f=>{f.addEventListener("click",()=>{const p=f,u=p.dataset.setting,g=p.dataset.value;if(p.parentElement.querySelectorAll(".btn-option").forEach(b=>b.classList.remove("active")),p.classList.add("active"),u==="lanes")E("laneCount",parseInt(g));else if(u==="reserveTime")E("reserveTime",parseInt(g));else if(u==="camera"){const b=g==="on";E("cameraEnabled",b),t(b)}else u==="mode"&&E("mode",g)})});const r=document.getElementById("controlsBtn"),n=document.getElementById("controlsModal"),l=document.getElementById("closeControlsBtn");r.addEventListener("click",()=>{n.style.display=""}),l.addEventListener("click",()=>{n.style.display="none"}),n.addEventListener("click",f=>{f.target===n&&(n.style.display="none")}),o.addEventListener("click",()=>{i.style.display="none",m()}),s.addEventListener("click",()=>{a.style.display="none",e()}),document.getElementById("menuBtn").addEventListener("click",()=>{a.style.display="none",i.style.display=""});const c=document.getElementById("titleScreen");if(c){c.addEventListener("click",()=>{c.classList.add("fade-out"),setTimeout(()=>{c.style.display="none",i.style.display=""},800)});const f=document.getElementById("leavesContainer");f&&setInterval(()=>{if(c.style.display==="none")return;const p=document.createElement("div");p.classList.add("falling-leaf");const u=Math.random()*100+"vw",g=Math.random()*20-10+"vw",b=Math.random()*5+5+"s",M=Math.random()*.5+.5,v=Math.random()*360+"deg";p.style.left=u,p.style.setProperty("--end-x",g),p.style.setProperty("--end-rotation",v),p.style.animationDuration=b,p.style.transform=`scale(${M})`,f.appendChild(p),setTimeout(()=>{p.remove()},parseFloat(b)*1e3)},400)}}function U(m,e){const t=document.getElementById("gameOverPanel"),i=document.getElementById("finalScore"),a=document.getElementById("bestScore");i.textContent=Math.floor(m).toString(),a.textContent=Math.floor(e).toString(),t.style.display=""}class I{constructor(e,t){d(this,"renderer");d(this,"player");d(this,"obstacles");d(this,"phaseManager");d(this,"reservation");d(this,"inputManager");d(this,"canvas");d(this,"running",!1);d(this,"gameOver",!1);d(this,"lastTime",0);d(this,"animationFrameId",null);d(this,"score",0);d(this,"baseSpeed",300);d(this,"realtimeBaseSpeed",200);d(this,"speed",300);d(this,"elapsedTotal",0);d(this,"speedIncreaseInterval",10);d(this,"speedIncreaseFactor",.15);d(this,"executeStartSpeed",400);d(this,"executeDuration",.5);d(this,"bestScore",0);this.canvas=e,this.renderer=new F(e),this.player=new $,this.obstacles=new j,this.reservation=new X,this.inputManager=t,this.phaseManager=new G(a=>this.onPhaseChange(a));const i=localStorage.getItem("projection_best_score");i&&(this.bestScore=parseFloat(i))}stop(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.running=!1}start(){this.stop(),this.reset(),this.running=!0,this.gameOver=!1,this.lastTime=performance.now(),this.phaseManager.start(),this.loop(this.lastTime)}reset(){this.score=0,this.elapsedTotal=0,this.speed=this.baseSpeed,this.player.reset(),this.obstacles.reset(),this.reservation.clear(),this.phaseManager.reset(),this.renderer.calcLayout(),this.inputManager.resetKeyboardLane()}restart(){this.start()}startTitleLoop(){this.stop(),this.reset(),this.phaseManager.phase="TITLE",this.running=!0,this.lastTime=performance.now(),this.loop(this.lastTime)}loop(e){if(!this.running)return;const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.update(t),this.draw(t),this.running&&!this.gameOver&&(this.animationFrameId=requestAnimationFrame(i=>this.loop(i)))}update(e){if(this.phaseManager.phase==="TITLE")return;this.phaseManager.update(e);const t=this.phaseManager.phase;switch(this.inputManager.update(e),t){case"READY":break;case"RESERVE":this.player.setLane(this.inputManager.currentLane),this.player.setAction(this.inputManager.currentAction),this.reservation.record(this.phaseManager.elapsed,this.player.lane,this.player.action);break;case"EXECUTE":{const o=this.phaseManager.progress,s=this.reservation.getLaneAtProgress(o),r=this.reservation.getActionAtProgress(o);this.player.setLane(s),this.player.setAction(r)}this.elapsedTotal+=e,this.updateSpeed();const i=this.speed*2;if(this.score+=i*e/10,this.obstacles.update(e,i,this.renderer.roadLeft,this.renderer.laneWidth,this.elapsedTotal),this.player.updatePosition(this.renderer.roadLeft,this.renderer.laneWidth,this.canvas.height,this.elapsedTotal),this.obstacles.checkCollision(this.player.getRect(),this.player.action,this.renderer.roadLeft,this.renderer.laneWidth)){this.endGame();return}break;case"REALTIME":this.player.setLane(this.inputManager.currentLane),this.player.setAction(this.inputManager.currentAction),this.elapsedTotal+=e,this.updateSpeed();const a=this.speed;if(this.score+=a*e/10,this.obstacles.update(e,a,this.renderer.roadLeft,this.renderer.laneWidth,this.elapsedTotal),this.player.updatePosition(this.renderer.roadLeft,this.renderer.laneWidth,this.canvas.height,this.elapsedTotal),this.obstacles.checkCollision(this.player.getRect(),this.player.action,this.renderer.roadLeft,this.renderer.laneWidth)){this.endGame();return}break}this.player.updatePosition(this.renderer.roadLeft,this.renderer.laneWidth,this.canvas.height,this.elapsedTotal)}updateSpeed(){const e=Math.floor(this.elapsedTotal/this.speedIncreaseInterval);this.speed=this.baseSpeed*Math.pow(1+this.speedIncreaseFactor,e)}draw(e){let t=this.speed;this.phaseManager.phase==="EXECUTE"?t=this.speed*2:this.phaseManager.phase==="REALTIME"&&(t=this.speed),this.renderer.render(this.player,this.obstacles,this.phaseManager.phase,this.phaseManager.timer,this.phaseManager.duration,this.score,t,this.reservation,e,this.executeStartSpeed*2,this.executeDuration)}onPhaseChange(e){switch(e){case"RESERVE":this.reservation.clear(),this.player.setAction("stand");break;case"EXECUTE":this.executeStartSpeed=this.speed,this.executeDuration=this.phaseManager.duration;break}}endGame(){this.running=!1,this.gameOver=!0,this.score>this.bestScore&&(this.bestScore=this.score,localStorage.setItem("projection_best_score",this.bestScore.toString())),U(this.score,this.bestScore)}}const V=[[0,1],[1,2],[2,3],[3,7],[0,4],[4,5],[5,6],[6,8],[11,12],[11,23],[12,24],[23,24],[11,13],[13,15],[12,14],[14,16],[23,25],[25,27],[24,26],[26,28]];class z{constructor(){d(this,"pose",null);d(this,"camera",null);d(this,"_inputX",0);d(this,"_smoothedX",0);d(this,"_inputY",0);d(this,"_smoothedY",0);d(this,"_baselineY",-1);d(this,"_calibrationFrames",0);d(this,"_calibrationSum",0);d(this,"_action","stand");d(this,"_active",!1);d(this,"videoEl");d(this,"previewVideoEl");d(this,"cameraDotEl");d(this,"previewEl");d(this,"skeletonCanvas");d(this,"skeletonCtx",null);d(this,"jumpThreshold",-.12);d(this,"crouchThreshold",.18);this.videoEl=document.getElementById("cameraVideo"),this.previewVideoEl=document.getElementById("previewVideo"),this.cameraDotEl=document.getElementById("cameraDot"),this.previewEl=document.getElementById("cameraPreview"),this.skeletonCanvas=document.getElementById("skeletonCanvas")}get inputX(){return this._smoothedX}get action(){return this._action}get active(){return this._active}async start(){try{this.pose=new Pose({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${t}`}),this.pose.setOptions({modelComplexity:0,smoothLandmarks:!0,minDetectionConfidence:.5,minTrackingConfidence:.5}),this.pose.onResults(t=>{this.onPoseResults(t)});const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:320,height:240}});return this.videoEl.srcObject=e,this.previewVideoEl.srcObject=e,this.camera=new Camera(this.videoEl,{onFrame:async()=>{this.pose&&await this.pose.send({image:this.videoEl})},width:320,height:240}),this.skeletonCanvas.width=320,this.skeletonCanvas.height=240,this.skeletonCtx=this.skeletonCanvas.getContext("2d"),this._baselineY=-1,this._calibrationFrames=0,this._calibrationSum=0,await this.camera.start(),this._active=!0,this.previewEl.style.display="block",!0}catch(e){return console.warn("カメラの初期化に失敗:",e),this._active=!1,!1}}stop(){this.camera&&this.camera.stop(),this._active=!1,this._action="stand",this.previewEl.style.display="none",this.videoEl.srcObject&&(this.videoEl.srcObject.getTracks().forEach(t=>t.stop()),this.videoEl.srcObject=null,this.previewVideoEl.srcObject=null)}onPoseResults(e){if(!e.poseLandmarks){this.skeletonCtx&&this.skeletonCtx.clearRect(0,0,320,240);return}const t=e.poseLandmarks;this.drawSkeleton(t);const i=t[11],a=t[12],o=t[23],s=t[24];if(t[25],t[26],t[15],t[16],t[27],t[28],!i||!a)return;const r=(i.x+a.x)/2;if(this._inputX=-(r-.5)*2,this._smoothedX=this._smoothedX*.8+this._inputX*.2,!o||!s||!i||!a)return;const n=(o.y+s.y)/2,l=(i.y+a.y)/2,h=(n+l)/2,c=t[0],f=c?c.y:l-.2;h>.8&&f>.8?this._action="pushup":n>.7?this._action="crouch":n<.4?this._action="jump":this._action="stand",this.cameraDotEl.style.display="none"}drawSkeleton(e){const t=this.skeletonCtx;if(!t)return;const i=320,a=240;t.clearRect(0,0,i,a),t.strokeStyle=this.getActionColor(.6),t.lineWidth=2;for(const[l,h]of V){const c=e[l],f=e[h];!c||!f||c.visibility<.3||f.visibility<.3||(t.beginPath(),t.moveTo(c.x*i,c.y*a),t.lineTo(f.x*i,f.y*a),t.stroke())}const o=this.getActionColor(.9),s=[0,11,12,13,14,15,16,23,24,25,26,27,28];for(const l of s){const h=e[l];!h||h.visibility<.3||(t.fillStyle=o,t.beginPath(),t.arc(h.x*i,h.y*a,3,0,Math.PI*2),t.fill())}const r=e[23],n=e[24];if(r&&n&&r.visibility>.3&&n.visibility>.3){const l=(r.x+n.x)/2*i,h=(r.y+n.y)/2*a;if(this._baselineY>0){const c=this._baselineY*a;t.strokeStyle="rgba(196, 164, 106, 0.4)",t.lineWidth=1,t.setLineDash([4,4]),t.beginPath(),t.moveTo(0,c),t.lineTo(i,c),t.stroke(),t.setLineDash([])}t.shadowColor=this.getActionColor(.6),t.shadowBlur=12,t.fillStyle=this.getActionColor(.9),t.beginPath(),t.arc(l,h,7,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1.5,t.beginPath(),t.arc(l,h,7,0,Math.PI*2),t.stroke(),t.shadowBlur=0,t.font="bold 14px 'Shippori Mincho', serif",t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.getActionColor(.9),t.shadowColor=this.getActionColor(.5),t.shadowBlur=8,this._action==="jump"?t.fillText("跳",l,h-18):this._action==="crouch"?t.fillText("伏",l,h-18):this._action==="pushup"&&t.fillText("腕",l,h-18),t.shadowBlur=0}}getActionColor(e){switch(this._action){case"jump":return`rgba(60, 255, 60, ${e})`;case"crouch":return`rgba(60, 100, 255, ${e})`;case"pushup":return`rgba(200, 50, 220, ${e})`;default:return`rgba(255, 60, 60, ${e})`}}drawThresholdGuides(e,t,i){e.save(),e.lineWidth=1,this.drawGuideLine(e,t,i,.3,"rgba(200, 50, 220, 0.5)"),this.drawGuideLine(e,t,i,.4,"rgba(60, 255, 60, 0.5)"),this.drawGuideLine(e,t,i,.7,"rgba(60, 100, 255, 0.5)"),e.restore()}drawGuideLine(e,t,i,a,o){const s=a*i;e.strokeStyle=o,e.beginPath(),e.moveTo(0,s),e.lineTo(t,s),e.stroke(),e.fillStyle=o,e.font="10px monospace",e.fillText(a.toFixed(1),4,s-2)}}class q{constructor(){d(this,"cameraInput");d(this,"keyboardLane",1);d(this,"_currentLane",1);d(this,"_currentAction","stand");d(this,"keysDown",new Set);d(this,"actionHoldTimer",0);d(this,"actionHoldType","stand");d(this,"actionHoldDuration",1);d(this,"lastRawAction","stand");this.cameraInput=new z,this.setupKeyboard()}get currentLane(){return this._currentLane}get currentAction(){return this._currentAction}setupKeyboard(){document.addEventListener("keydown",e=>{this.keysDown.add(e.key),e.key==="ArrowLeft"?this.keyboardLane=Math.max(0,this.keyboardLane-1):e.key==="ArrowRight"&&(this.keyboardLane=Math.min(y.laneCount-1,this.keyboardLane+1))}),document.addEventListener("keyup",e=>{this.keysDown.delete(e.key)})}async enableCamera(){return await this.cameraInput.start()}disableCamera(){this.cameraInput.stop()}get isCameraActive(){return this.cameraInput.active}update(e=1/60){let t="stand";y.cameraEnabled&&this.cameraInput.active?(this._currentLane=this.cameraToLane(this.cameraInput.inputX),this.keysDown.has("ArrowUp")||this.keysDown.has(" ")?t="jump":this.keysDown.has("Shift")?t="pushup":this.keysDown.has("ArrowDown")?t="crouch":t=this.cameraInput.action):(this._currentLane=this.keyboardLane,this.keysDown.has("ArrowUp")||this.keysDown.has(" ")?t="jump":this.keysDown.has("Shift")?t="pushup":this.keysDown.has("ArrowDown")?t="crouch":t="stand"),t!=="stand"?(t!==this.lastRawAction&&(this.actionHoldTimer=this.actionHoldDuration,this.actionHoldType=t),this._currentAction=t):this.actionHoldTimer>0?this._currentAction=this.actionHoldType:this._currentAction="stand",this.actionHoldTimer>0&&(this.actionHoldTimer-=e),this.lastRawAction=t}cameraToLane(e){return y.laneCount===3?e<-.15?0:e>.15?2:1:e<0?0:1}resetKeyboardLane(){this.keyboardLane=y.laneCount===3?1:0,this._currentLane=this.keyboardLane,this._currentAction="stand",this.actionHoldTimer=0,this.actionHoldType="stand",this.keysDown.clear()}}const k=document.getElementById("gameCanvas");function R(){k.width=window.innerWidth,k.height=window.innerHeight}R();window.addEventListener("resize",R);const P=new q;let w=null;w=new I(k,P);w.startTitleLoop();function A(){w&&w.stop(),w=new I(k,P),w.start()}function N(){w?w.restart():A()}async function K(m){m?await P.enableCamera()||console.warn("カメラが使用できません。キーボード操作に切替"):P.disableCamera()}H(A,N,K);
